version: v1.0
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu2004
# fail_fast:
#   cancel:
#     when: branch != 'main'
auto_cancel:
  queued:
    when: branch != 'main'
  running:
    when: branch != 'main'
blocks:
  - name: Install dependencies
    task:
      secrets:
          - name: playground-client-build
      prologue:
        commands:
          - checkout
          - nvm install && nvm use
          
      jobs:
        - name: yarn install and cache
          commands:
            - dev
            - cache restore node_modules-$(checksum yarn.lock),node_modules-$SEMAPHORE_GIT_BRANCH,node_modules-main
            - cache restore yarn-$(checksum yarn.lock),yarn-$SEMAPHORE_GIT_BRANCH,yarn-main
            - yarn --frozen-lockfile
            - cache store node_modules-$SEMAPHORE_GIT_BRANCH node_modules
            - cache store node_modules-$(checksum yarn.lock) node_modules
            - cache store yarn-$(checksum yarn.lock) ~/.cache/yarn
            - cache store yarn-$SEMAPHORE_GIT_BRANCH ~/.cache/yarn

promotions:
  - name: Deploy - playground (playground.abyssfabric.co)
    pipeline_file: playground-deploy.yml
